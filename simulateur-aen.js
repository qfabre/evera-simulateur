const WEBHOOK_URL="https://hooks.zapier.com/hooks/catch/18497227/2xsufh3/";
const $=id=>document.getElementById(id),V=id=>parseFloat($(id).value)||0,fmt=n=>new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n),fK=n=>n.toLocaleString('fr-FR')+' km',qA=s=>document.querySelectorAll(s);
let carbI=1,cD=null,mAt=0,userIP=null;
const IP_COOLDOWN=604800000;const IP_STORAGE_KEY='aen_submissions';const CALC_COUNT_KEY='aen_calc_count';
function getCalcCount(){try{return parseInt(localStorage.getItem(CALC_COUNT_KEY))||0}catch(e){return 0}}
function incrementCalcCount(){try{localStorage.setItem(CALC_COUNT_KEY,getCalcCount()+1)}catch(e){}}
function lockCalcBtn(){const b=document.querySelector('.btn-calc');if(!b)return;b.disabled=true;b.removeAttribute('onclick');b.style.setProperty('opacity','0.4','important');b.style.setProperty('pointer-events','none','important');b.style.setProperty('cursor','not-allowed','important');const w=b.closest('.cta-wrap');if(w&&!w.querySelector('.calc-blocked')){const msg=document.createElement('div');msg.className='calc-blocked';msg.innerHTML='Pour faire d\u2019autres simulations, <a href="https://evera.co/fleet/planifiez-votre-demonstration" target="_blank" style="color:#D44444;font-weight:700;text-decoration:underline">prenez rendez-vous avec nos experts</a>.';msg.style.cssText='text-align:center;padding:12px 16px;margin-top:10px;background:#FEF3F3;border:1px solid #D44444;border-radius:8px;color:#D44444;font-family:Inter,sans-serif;font-size:14px;font-weight:500';w.appendChild(msg)}}
if(getCalcCount()>=1){document.addEventListener('DOMContentLoaded',lockCalcBtn);if(document.readyState!=='loading')lockCalcBtn()}
(function(){try{fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{userIP=d.ip}).catch(()=>{})}catch(e){}})();
function canSubmitIP(){if(!userIP)return true;try{const subs=JSON.parse(localStorage.getItem(IP_STORAGE_KEY)||'{}');const last=subs[userIP];if(last&&Date.now()-last<IP_COOLDOWN)return false}catch(e){}return true}
function markSubmitIP(){if(!userIP)return;try{const subs=JSON.parse(localStorage.getItem(IP_STORAGE_KEY)||'{}');const now=Date.now();Object.keys(subs).forEach(k=>{if(now-subs[k]>IP_COOLDOWN)delete subs[k]});subs[userIP]=now;localStorage.setItem(IP_STORAGE_KEY,JSON.stringify(subs))}catch(e){}}
function setMoto(e){qA('.moto-card').forEach(c=>c.classList.remove('active'));e.classList.add('active');const t=e.dataset.type,el=t==='electrique'||t==='eco-score',ph=t==='phev',hy=t==='hybride';$('consoUnit').textContent=el?'kWh/100km':'L/100km';$('prixUnit').textContent=el?'€/kWh':'€/L';$('conso').value=el?'25':ph?'4':hy?'5':'6';$('prix').value=el?'0.40':'1.70';if(el){$('toggleCarb').classList.remove('on');$('toggleCarb').style.opacity='0.4';$('toggleCarb').style.pointerEvents='none';$('carbHint').textContent="Forfait à 50 % — l'énergie n'est pas prise en compte pour les véhicules électriques"}else{$('toggleCarb').style.opacity='';$('toggleCarb').style.pointerEvents='';$('toggleCarb').classList.toggle('on',carbI);$('carbHint').textContent=carbI?"Forfait à 67 % — l'énergie est incluse dans le calcul des avantages en nature":"Forfait à 50 % — l'énergie n'est pas incluse dans le calcul des avantages en nature"}}
function setAcq(e){qA('.acq-opt').forEach(c=>{c.classList.remove('active');c.style.setProperty('background','#FFF','important');c.style.setProperty('border','1.5px solid #E0E7EB','important')});e.classList.add('active');e.style.setProperty('background','#D8F3F2','important');e.style.setProperty('border','1.5px solid #D0EDED','important');const a=e.dataset.acq,ci='<svg class="ico"><use href="#ico-card"/></svg> ';$('loyerLabel').innerHTML=ci+(a==='achat'?"Coût d'achat TTC <span class=\"tip\" data-t=\"Prix d'achat total TTC\">?</span>":a==='credit'?"Loyer crédit-bail annuel TTC <span class=\"tip\" data-t=\"Montant annuel crédit-bail TTC\">?</span>":"Loyer annuel TTC <span class=\"tip\" data-t=\"Loyer annuel TTC (LLD ou LOA)\">?</span>")}
function setFleet(e){qA('.fp').forEach(b=>b.classList.remove('active'));e.classList.add('active');$('flotte').value=e.dataset.v;document.querySelector('.fleet-presets').classList.remove('fleet-required');$('errFlotte').style.display='none'}
function syncFleetBtns(){const v=parseInt($('flotte').value)||1;qA('.fp').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.v)===v));if(v>=1){document.querySelector('.fleet-presets').classList.remove('fleet-required');$('errFlotte').style.display='none'}}
function toggleCarburant(){carbI=!carbI;$('toggleCarb').classList.toggle('on',carbI);$('carbHint').textContent=carbI?"Forfait à 67 % — l'énergie est incluse dans le calcul des avantages en nature":"Forfait à 50 % — l'énergie n'est pas incluse dans le calcul des avantages en nature"}
['fraisAssurance','fraisEntretien','fraisPneus'].forEach(id=>{$(id).addEventListener('input',()=>{$('fraisTotal').textContent=(V('fraisAssurance')+V('fraisEntretien')+V('fraisPneus')).toLocaleString('fr-FR')+' €/an'})});
function sliderFill(el){const mn=parseFloat(el.min),mx=parseFloat(el.max),v=parseFloat(el.value),pct=((v-mn)/(mx-mn))*100;el.style.background=`linear-gradient(to right,#63768D 0%,#63768D ${pct}%,#E0E7EB ${pct}%,#E0E7EB 100%)`}
function updateKm(){const t=parseInt($('kmTotal').value),p=Math.min(parseInt($('kmPerso').value),t);$('kmTotalVal').textContent=fK(t);$('kmPerso').max=t;$('kmPerso').value=p;$('kmPersoVal').textContent=fK(p);$('kmPersoMax').textContent=fK(t);const r=t>0?Math.round(p/t*100):0;$('kmPercPerso').textContent=r+'%';$('kmPercPro').textContent=(100-r)+'%';sliderFill($('kmTotal'));sliderFill($('kmPerso'))}
updateKm();
function runCalc(){const fr=V('fraisAssurance')+V('fraisEntretien')+V('fraisPneus'),moto=document.querySelector('.moto-card.active')?.dataset.type,isElec=moto==='electrique',isEco=moto==='eco-score',isEV=isElec||isEco,p={l:V('loyer'),fr,co:V('conso'),px:V('prix'),kT:parseInt($('kmTotal').value),kP:parseInt($('kmPerso').value),tS:V('tauxSal')/100,tP:V('tauxPat')/100,tmi:parseFloat($('tmi').value)/100,fl:Math.max(1,parseInt($('flotte').value)||1),ci:carbI,moto},r=p.kP/p.kT,nT=(p.kT*p.co/100)*p.px,nP=((p.kT-p.kP)*p.co/100)*p.px,nE=isEV?0:(p.ci?nT:nP);function sc(a,l,ne){const cs=a*p.tS,ir=a*p.tmi,v=l+p.fr+ne,cp=a*p.tP;return{aen:a,cS:cs,ir,tS:cs+ir,veh:v,cP:cp,tE:v+cp}}let aFF,aFR;if(isEco){aFF=(p.l+p.fr)*.5*.3;aFR=(p.l+p.fr)*r*.5}else if(isElec){aFF=(p.l+p.fr)*.5;aFR=(p.l+p.fr)*r}else{aFF=p.ci?(p.l+p.fr+nT)*.67:(p.l+p.fr)*.5;aFR=p.ci?(p.l+p.fr+nT)*r:(p.l+p.fr)*r}const nEl=0;cD={p,s:[sc(aFF,p.l,nE),sc(aFR,p.l,nE),sc((p.l+p.fr)*.5*.3,p.l,nEl),sc((p.l+p.fr)*r*.5,p.l,nEl)]}}
function onCalculate(){if(getCalcCount()>=1){lockCalcBtn();return}const flV=parseInt($('flotte').value);if(!flV||flV<1){const fp=document.querySelector('.fleet-presets');fp.classList.remove('fleet-required');void fp.offsetWidth;fp.classList.add('fleet-required');$('errFlotte').style.display='block';$('flotte').scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>$('flotte').focus(),400);return}document.querySelector('.fleet-presets').classList.remove('fleet-required');$('errFlotte').style.display='none';if(parseInt($('kmTotal').value)<=0)return;runCalc();const s=cD.s,fl=cD.p.fl,sv=((s[0].tS+s[0].tE)-(s[1].tS+s[1].tE))*fl;$('modalSavValue').textContent=fmt(Math.abs(sv));$('modalSavLabel').textContent=fl>1?`d'économies / an sur votre flotte de ${fl} véhicules`:`d'économies / an sur votre flotte`;mAt=Date.now();$('modal').classList.add('open');clE();setTimeout(()=>$('leadPrenom').focus(),150)}
function showResults(){const s=cD.s,fl=cD.p.fl,isEV=cD.p.moto==='electrique'||cD.p.moto==='eco-score',vhLbl=isEV?'Coût véhicule':'Coût véhicule + énergie',tF=s[0].tS+s[0].tE,tR=s[1].tS+s[1].tE,df=tF-tR;$('heroSav').textContent=fmt(df);$('heroFlotteLabel').textContent=fl>1?' par véhicule / an':' par an';const hft=$('heroFleetTotal');if(hft){if(fl>1){hft.textContent='Soit '+fmt(df*fl)+' pour '+fl+' véhicules';hft.style.display='block'}else{hft.style.display='none'}}$('heroForf').textContent=fmt(tF);$('heroReel').textContent=fmt(tR);$('heroArrow').textContent=(df>=0?'−':'+')+fmt(Math.abs(df)).replace(/[^\d\s]/g,'').trim()+' €';$('r_f_veh').previousElementSibling.textContent=vhLbl;$('r_r_veh').previousElementSibling.textContent=vhLbl;const mp={aen:'aen',cS:'cs',ir:'ir',tS:'ts',veh:'veh',cP:'cp',tE:'te'},fi=(pre,d)=>{for(let k in mp)$(pre+'_'+mp[k]).textContent=fmt(d[k])};fi('r_r',s[1]);fi('r_f',s[0]);fi('e_f',s[2]);fi('e_r',s[3]);const rw=[['Avantage en nature','aen'],['Charges salariales','cS'],['Impôt sur le revenu','ir'],['Coût total salarié','tS',1],[vhLbl,'veh'],['Charges patronales','cP'],['Coût total employeur','tE',1]];let h='';rw.forEach(([lb,k,hl])=>{const vs=s.map(x=>x[k]),mn=Math.min(...vs);h+=`<tr${hl?' class="hl"':''}><td>${lb}</td>`;vs.forEach(v=>{h+=`<td${v===mn?' style="color:var(--bleu-fonce);font-weight:700"':''}>${fmt(v)}</td>`});h+='</tr>'});$('ftableBody').innerHTML=h;const fct=$('fcTitle');if(fct){const ecTot=Math.abs(df*fl);fct.textContent=fl>1?'Réduisez vos coûts de '+fmt(ecTot)+' / an grâce à Evera Fleet':'Réduisez vos coûts de '+fmt(Math.abs(df))+' / an grâce à Evera Fleet'}$('results').classList.add('visible');$('results').scrollIntoView({behavior:'smooth',block:'start'});incrementCalcCount();lockCalcBtn()}
const BD='mailinator.com yopmail.com yopmail.fr guerrillamail.com tempmail.com throwaway.email sharklasers.com grr.la dispostable.com maildrop.cc trashmail.com temp-mail.org fakeinbox.com tmpmail.net mohmal.com getnada.com discard.email jetable.org mytemp.email tempail.com burnermail.io meltmail.com mailsac.com'.split(' ');
const FD='gmail.com yahoo.com yahoo.fr hotmail.com hotmail.fr outlook.com outlook.fr live.com live.fr aol.com icloud.com me.com mail.com gmx.com gmx.fr protonmail.com proton.me zoho.com free.fr orange.fr wanadoo.fr laposte.net sfr.fr bbox.fr numericable.fr msn.com msn.fr'.split(' ');
const TP=[/^test/i,/^fake/i,/^demo/i,/^abc$/i,/^aaa/i,/^xxx/i,/^zzz/i,/^qwer/i,/^asdf/i,/^azerty/i,/^toto/i,/^tutu/i,/^tata/i,/^foo$/i,/^bar$/i,/^null/i,/^none/i,/^admin$/i,/^blabla/i];
const NJ=[/^test$/i,/^fake$/i,/^demo$/i,/^abc$/i,/^aaa$/i,/^xxx$/i,/^zzz$/i,/^toto$/i,/^tata$/i,/^tutu$/i,/^foo$/i,/^bar$/i,/^null$/i,/^none$/i,/^na$/i,/^n\/a$/i,/^\.$/,/^-$/,/^\?$/,/^x$/i,/^qq$/i,/^azerty$/i,/^blabla$/i,/^fdp$/i];
function sE(id,m){const e=$(id);e.querySelector('span').textContent=m;e.classList.add('show');const i=e.previousElementSibling;if(i&&i.classList.contains('input'))i.classList.add('input-err')}
function clE(){qA('.field-err').forEach(e=>{e.classList.remove('show');const i=e.previousElementSibling;if(i&&i.classList.contains('input'))i.classList.remove('input-err')})}
function vL(){clE();let ok=1;const p=$('leadPrenom').value.trim(),n=$('leadNom').value.trim(),em=$('leadEmail').value.trim().toLowerCase(),en=$('leadEntreprise').value.trim();if($('leadWebsite').value.trim())return 0;if(Date.now()-mAt<2e3)return 0;if(!p){sE('errPrenom','Prénom requis');ok=0}else if(p.length<2){sE('errPrenom','Prénom trop court');ok=0}else if(NJ.some(r=>r.test(p))){sE('errPrenom','Prénom invalide');ok=0}else if(/\d/.test(p)){sE('errPrenom','Pas de chiffres');ok=0}
if(!n){sE('errNom','Nom requis');ok=0}else if(n.length<2){sE('errNom','Nom trop court');ok=0}else if(NJ.some(r=>r.test(n))){sE('errNom','Nom invalide');ok=0}else if(/\d/.test(n)){sE('errNom','Pas de chiffres');ok=0}
if(!em){sE('errEmail','Email requis');ok=0}else if(!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(em)){sE('errEmail','Email invalide');ok=0}else{const d=em.split('@')[1],l=em.split('@')[0];if(BD.includes(d)){sE('errEmail','Email jetable interdit');ok=0}else if(FD.includes(d)){sE('errEmail','Utilisez votre email pro');ok=0}else if(TP.some(r=>r.test(l))){sE('errEmail','Email invalide');ok=0}else if(d.length<4||!d.includes('.')){sE('errEmail','Domaine invalide');ok=0}}
if(!en){sE('errEntreprise','Entreprise requise');ok=0}else if(en.length<2){sE('errEntreprise','Nom trop court');ok=0}else if(NJ.some(r=>r.test(en))){sE('errEntreprise','Nom invalide');ok=0}
const tel=$('leadTel').value.replace(/[\s.\-()]/g,'');if(tel&&!/^(\+?\d{10,15})$/.test(tel)){sE('errTel','Numéro invalide (ex: 06 12 34 56 78)');ok=0}
return ok}
function closeModal(){$('modal').classList.remove('open')}
function submitLead(){if(!vL())return;if(!canSubmitIP()){sE('errEmail','Une simulation a déjà été soumise depuis cette connexion');return}const b=$('btnSubmit');b.disabled=1;b.innerHTML='<span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite"></span> Envoi…';const fl=parseInt($('flotte').value)||1,kT=parseInt($('kmTotal').value),kP=parseInt($('kmPerso').value),s=cD.s,pay={prenom:$('leadPrenom').value.trim(),nom:$('leadNom').value.trim(),email:$('leadEmail').value.trim().toLowerCase(),entreprise:$('leadEntreprise').value.trim(),telephone:$('leadTel').value.trim(),nombre_vehicules:fl,timestamp:new Date().toISOString(),source:'simulateur-aen',motorisation:document.querySelector('.moto-card.active')?.dataset.type,acquisition:document.querySelector('.acq-opt.active')?.dataset.acq||'lld',loyer:V('loyer'),conso:V('conso'),prix_carburant:V('prix'),carburant_inclus:carbI,assurance:V('fraisAssurance'),entretien:V('fraisEntretien'),pneumatiques:V('fraisPneus'),km_total:kT,km_perso:kP,pct_perso:Math.round(kP/kT*100),taux_sal:$('tauxSal').value+'%',taux_pat:$('tauxPat').value+'%',tmi:$('tmi').value+'%',eco_vehicule:Math.round((s[0].tS+s[0].tE)-(s[1].tS+s[1].tE)),eco_flotte:Math.round(((s[0].tS+s[0].tE)-(s[1].tS+s[1].tE))*fl),aen_forfait:Math.round(s[0].aen),aen_reel:Math.round(s[1].aen)};if(WEBHOOK_URL)fetch(WEBHOOK_URL,{method:'POST',body:JSON.stringify(pay)}).catch(()=>{});markSubmitIP();setTimeout(()=>{b.disabled=0;b.innerHTML='Résultats détaillés <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';closeModal();showResults()},800)}
function skipLead(){closeModal();showResults()}
['leadPrenom','leadNom','leadEmail','leadEntreprise','leadTel'].forEach(id=>{$(id).addEventListener('input',()=>{const e=id==='leadTel'?'errTel':'err'+id.charAt(4).toUpperCase()+id.slice(5);if($(e)){$(e).classList.remove('show');$(id).classList.remove('input-err')}})});
function updateFiscalHint(){document.querySelector('.ft-hint').textContent=`— Cot. sal. ${$('tauxSal').value}% · Cot. pat. ${$('tauxPat').value}% · TMI ${$('tmi').value}%`}
function toggleElec(){$('elecContent').classList.toggle('open');$('elecToggle').classList.toggle('open')}
function toggleTable(){const c=$('fullTable'),t=$('tableToggle'),o=c.classList.toggle('open');t.classList.toggle('open',o);const sv='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg> ';t.innerHTML=o?sv+'Masquer le tableau':sv+'Tableau récapitulatif des 4 scénarios'}
function newSim(){['results','elecContent','elecToggle','fullTable','tableToggle'].forEach(id=>$(id).classList.remove('visible','open'));if($('calcDebug'))$('calcDebug').style.display='none';window.scrollTo({top:0,behavior:'smooth'})}
function fixPad(){qA('.sim .evc:not(.evc-sm):not(.evc-np)').forEach(el=>el.style.setProperty('padding','24px 24px 20px','important'));qA('.sim .evc-sm').forEach(el=>el.style.setProperty('padding','16px 20px','important'));qA('.sim .evc-np').forEach(el=>el.style.setProperty('padding','0','important'))}
fixPad();window.addEventListener('load',fixPad);setTimeout(fixPad,1500);setTimeout(fixPad,4000);
$('leadEmail').addEventListener('input',function(){const em=this.value.trim().toLowerCase();if(/@evera\.co$/i.test(em)&&em.split('@')[0].length>1){closeModal();showResults();try{localStorage.removeItem(CALC_COUNT_KEY)}catch(e){}const bl=document.querySelector('.calc-blocked');if(bl)bl.remove();const b=document.querySelector('.btn-calc');if(b){b.disabled=false;b.setAttribute('onclick','onCalculate()');b.style.removeProperty('opacity');b.style.removeProperty('pointer-events');b.style.removeProperty('cursor')}showCalcDebug()}});
function showCalcDebug(){if(!cD)return;const p=cD.p,s=cD.s,fN=n=>Math.round(n).toLocaleString('fr-FR'),pct=n=>(n*100).toFixed(1).replace('.',',')+' %';const isElec=p.moto==='electrique',isEco=p.moto==='eco-score',isEV=isElec||isEco;const r=p.kP/p.kT,kPro=p.kT-p.kP,nT=(p.kT*p.co/100)*p.px,nP=(kPro*p.co/100)*p.px,nE=isEV?0:(p.ci?nT:nP);const tS=Math.round(p.tS*100),tP=Math.round(p.tP*100),tmi=Math.round(p.tmi*100);let ruleF,fmF,ruleR,fmR;if(isEco){ruleF='Éco-score → abattement 50 % + bonus 70 % (art. 3 arrêté 2025)';fmF=`= (loyer + frais) × 50 % × 30 %\n= (${fN(p.l)} + ${fN(p.fr)}) × 0,50 × 0,30\n= ${fN(p.l+p.fr)} × 0,15\n= ${fmt(s[0].aen)}`;ruleR='Réel éco-score → dépenses × ratio perso × abattement 50 %';fmR=`= (loyer + frais) × r × 50 %\n= (${fN(p.l)} + ${fN(p.fr)}) × ${pct(r)} × 0,50\n= ${fmt(s[1].aen)}`}else if(isElec){ruleF='Électrique (non éco-scoré) → forfait à 50 % (pas d\'abattement)';fmF=`= (loyer + frais) × 50 %\n= (${fN(p.l)} + ${fN(p.fr)}) × 0,50\n= ${fmt(s[0].aen)}`;ruleR='Réel électrique (non éco-scoré) → dépenses × ratio perso (pas d\'abattement)';fmR=`= (loyer + frais) × r\n= (${fN(p.l)} + ${fN(p.fr)}) × ${pct(r)}\n= ${fmt(s[1].aen)}`}else if(p.ci){ruleF='Carburant pris en charge par l\'employeur → forfait à 67 %';fmF=`= (loyer + frais + énergie) × 67 %\n= (${fN(p.l)} + ${fN(p.fr)} + ${fN(nT)}) × 0,67\n= ${fN(p.l+p.fr+nT)} × 0,67\n= ${fmt(s[0].aen)}`;ruleR='Réel → (dépenses + énergie totale) × ratio perso';fmR=`= (loyer + frais + énergie_total) × r\n= (${fN(p.l)} + ${fN(p.fr)} + ${fN(nT)}) × ${pct(r)}\n= ${fN(p.l+p.fr+nT)} × ${pct(r)}\n= ${fmt(s[1].aen)}`}else{ruleF='Carburant non inclus → forfait à 50 %';fmF=`= (loyer + frais) × 50 %\n= (${fN(p.l)} + ${fN(p.fr)}) × 0,50\n= ${fN(p.l+p.fr)} × 0,50\n= ${fmt(s[0].aen)}`;ruleR='Réel → dépenses × ratio perso';fmR=`= (loyer + frais) × r\n= (${fN(p.l)} + ${fN(p.fr)}) × ${pct(r)}\n= ${fN(p.l+p.fr)} × ${pct(r)}\n= ${fmt(s[1].aen)}`}function dcp(sc){const a=fmt(sc.aen);return`<div class="cd-row"><span>Charges salariales = AEN × ${tS} %</span><span class="cd-val">${fN(sc.aen)} × ${tS} % = ${fmt(sc.cS)}</span></div><div class="cd-row"><span>Impôt sur le revenu = AEN × TMI ${tmi} %</span><span class="cd-val">${fN(sc.aen)} × ${tmi} % = ${fmt(sc.ir)}</span></div><div class="cd-row cd-total"><span>Coût total salarié</span><span class="cd-val">${fmt(sc.cS)} + ${fmt(sc.ir)} = ${fmt(sc.tS)}</span></div><div class="cd-row"><span>${isEV?'Véhicule = loyer + frais':'Véhicule + énergie = loyer + frais + énergie'}</span><span class="cd-val">${isEV?fN(p.l)+' + '+fN(p.fr):fN(p.l)+' + '+fN(p.fr)+' + '+fN(nE)} = ${fmt(sc.veh)}</span></div><div class="cd-row"><span>Charges patronales = AEN × ${tP} %</span><span class="cd-val">${fN(sc.aen)} × ${tP} % = ${fmt(sc.cP)}</span></div><div class="cd-row cd-total"><span>Coût total employeur</span><span class="cd-val">${fmt(sc.veh)} + ${fmt(sc.cP)} = ${fmt(sc.tE)}</span></div>`}const eco=(s[0].tS+s[0].tE)-(s[1].tS+s[1].tE);let h='<h4>Détail des calculs — mode interne Evera</h4>';h+='<h5>Entrées</h5>';h+=`<div class="cd-row"><span>Loyer annuel TTC</span><span class="cd-val">${fmt(p.l)}</span></div>`;h+=`<div class="cd-row"><span>Frais annexes (ass. ${fmt(V('fraisAssurance'))} + ent. ${fmt(V('fraisEntretien'))} + pneus ${fmt(V('fraisPneus'))})</span><span class="cd-val">${fmt(p.fr)}</span></div>`;h+=`<div class="cd-row"><span>Km total / Km perso / Km pro</span><span class="cd-val">${fN(p.kT)} / ${fN(p.kP)} / ${fN(kPro)} km</span></div>`;h+=`<div class="cd-row"><span>Ratio perso (r = km_perso ÷ km_total)</span><span class="cd-val">${fN(p.kP)} ÷ ${fN(p.kT)} = ${pct(r)}</span></div>`;h+=`<div class="cd-row"><span>Taux cotisations sal. / pat. / TMI</span><span class="cd-val">${tS} % / ${tP} % / ${tmi} %</span></div>`;h+=`<div class="cd-row"><span>Carburant pris en charge</span><span class="cd-val">${p.ci?'Oui (forfait 67 %)':'Non (forfait 50 %)'}</span></div>`;if(!isElec&&!isEco){h+='<h5>Énergie</h5>';h+=`<div class="cd-row"><span>Coût énergie total (nT) = (km_total × conso ÷ 100) × prix</span><span class="cd-val">(${fN(p.kT)} × ${p.co} ÷ 100) × ${p.px} = ${fmt(nT)}</span></div>`;h+=`<div class="cd-row"><span>Coût énergie pro (nP) = (km_pro × conso ÷ 100) × prix</span><span class="cd-val">(${fN(kPro)} × ${p.co} ÷ 100) × ${p.px} = ${fmt(nP)}</span></div>`}h+='<h5>AEN Forfait</h5>';h+=`<div class="cd-rule">${ruleF}</div><pre class="cd-formula">${fmF}</pre>`;h+='<h5>AEN Réel</h5>';h+=`<div class="cd-rule">${ruleR}</div><pre class="cd-formula">${fmR}</pre>`;h+='<h5>Décomposition Forfait (AEN = '+fmt(s[0].aen)+')</h5>';h+=dcp(s[0]);h+='<h5>Décomposition Réel (AEN = '+fmt(s[1].aen)+')</h5>';h+=dcp(s[1]);h+='<h5>Économie</h5>';h+=`<div class="cd-row"><span>Total annuel Forfait</span><span class="cd-val">${fmt(s[0].tS)} + ${fmt(s[0].tE)} = ${fmt(s[0].tS+s[0].tE)}</span></div>`;h+=`<div class="cd-row"><span>Total annuel Réel</span><span class="cd-val">${fmt(s[1].tS)} + ${fmt(s[1].tE)} = ${fmt(s[1].tS+s[1].tE)}</span></div>`;h+=`<div class="cd-eco">Économie / véhicule / an = ${fmt(s[0].tS+s[0].tE)} − ${fmt(s[1].tS+s[1].tE)} = ${fmt(eco)}</div>`;if(p.fl>1)h+=`<div class="cd-eco" style="margin-top:6px">× ${p.fl} véhicules = ${fmt(eco*p.fl)}</div>`;$('calcDebug').innerHTML=h;$('calcDebug').style.display='block'}
function downloadPDF(){const{jsPDF}=window.jspdf;if(!jsPDF||!cD)return;const doc=new jsPDF(),s=cD.s,fl=cD.p.fl,isEV=cD.p.moto==='electrique'||cD.p.moto==='eco-score',vhLbl=isEV?'Coût véhicule':'Coût véhicule + énergie',L=20,W=170;let y=20;const tF=s[0].tS+s[0].tE,tR=s[1].tS+s[1].tE,eco=tF-tR;doc.setFont('helvetica','bold');doc.setFontSize(18);doc.setTextColor(19,27,29);doc.text('Simulation Avantage en Nature',L,y);y+=8;doc.setFont('helvetica','normal');doc.setFontSize(10);doc.setTextColor(100,118,141);doc.text('Rapport généré le '+new Date().toLocaleDateString('fr-FR')+' — evera.co',L,y);y+=4;doc.setDrawColor(224,231,235);doc.line(L,y,L+W,y);y+=10;doc.setFont('helvetica','bold');doc.setFontSize(12);doc.setTextColor(19,27,29);doc.text('Paramètres du véhicule',L,y);y+=7;const moto=document.querySelector('.moto-card.active .mc-label')?.textContent||'—';const acq=document.querySelector('.acq-opt.active .acq-name')?.textContent||'—';const params=[['Motorisation',moto],['Acquisition',acq],['Loyer / Coût TTC',V('loyer').toLocaleString('fr-FR')+' €'],['Consommation',V('conso')+' '+$('consoUnit').textContent],['Prix énergie',V('prix')+' '+$('prixUnit').textContent],['Carburant inclus',carbI?'Oui':'Non'],['Assurance',V('fraisAssurance').toLocaleString('fr-FR')+' €/an'],['Entretien',V('fraisEntretien').toLocaleString('fr-FR')+' €/an'],['Pneumatiques',V('fraisPneus').toLocaleString('fr-FR')+' €/an'],['Km total annuel',parseInt($('kmTotal').value).toLocaleString('fr-FR')+' km'],['Km perso',parseInt($('kmPerso').value).toLocaleString('fr-FR')+' km'],['% perso',Math.round(parseInt($('kmPerso').value)/parseInt($('kmTotal').value)*100)+' %'],['Nb véhicules',''+fl]];doc.setFontSize(9);params.forEach(([lb,vl])=>{doc.setFont('helvetica','normal');doc.setTextColor(100,118,141);doc.text(lb,L,y);doc.setFont('helvetica','bold');doc.setTextColor(19,27,29);doc.text(vl,L+55,y);y+=5});y+=4;doc.setDrawColor(224,231,235);doc.line(L,y,L+W,y);y+=10;doc.setFont('helvetica','bold');doc.setFontSize(12);doc.setTextColor(19,27,29);doc.text('Résultats — Forfait vs Réel',L,y);y+=8;const c1=L,c2=L+80,c3=L+135;doc.setFontSize(8);doc.setFont('helvetica','bold');doc.setTextColor(154,172,184);doc.text('FORFAIT',c2,y);doc.text('RÉEL (EVERA)',c3,y);y+=3;doc.line(L,y,L+W,y);y+=6;const rows=[['CÔTÉ SALARIÉ',null,1],['Avantage en nature','aen'],['Charges salariales','cS'],["Impôt sur le revenu",'ir'],['Coût total salarié','tS',0,1],['CÔTÉ EMPLOYEUR',null,1],[vhLbl,'veh'],['Charges patronales','cP'],['Coût total employeur','tE',0,1]];doc.setFontSize(9);rows.forEach(([lb,k,isH,isB])=>{if(isH){doc.setFont('helvetica','bold');doc.setFontSize(8);doc.setTextColor(100,118,141);doc.text(lb,c1,y);y+=5;return}doc.setFont('helvetica',isB?'bold':'normal');doc.setTextColor(100,118,141);doc.setFontSize(isB?10:9);doc.text(lb,c1+2,y);doc.setFont('helvetica',isB?'bold':'normal');doc.setTextColor(19,27,29);doc.text(fmt(s[0][k]),c2,y);doc.setTextColor(26,138,132);doc.text(fmt(s[1][k]),c3,y);y+=isB?6:5;if(isB){doc.setDrawColor(224,231,235);doc.line(L,y,L+W,y);y+=6}});y+=4;doc.setFont('helvetica','bold');doc.setFontSize(16);doc.setTextColor(26,138,132);doc.text('Économie : '+fmt(Math.abs(eco))+' / véhicule / an',L,y);if(fl>1){y+=8;doc.setFontSize(13);doc.text('Soit '+fmt(Math.abs(eco*fl))+' pour '+fl+' véhicules',L,y)}y+=14;doc.setFont('helvetica','normal');doc.setFontSize(8);doc.setTextColor(154,172,184);doc.text('Ce rapport est une estimation indicative basée sur les paramètres saisis. Résultats calculés sur evera.co.',L,y);doc.save('simulation-aen-evera.pdf')}
